name: Deploy Hugo site to OVH

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.deb \
            https://github.com/gohugoio/hugo/releases/download/v0.128.0/hugo_extended_0.128.0_linux-amd64.deb
          sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Build Hugo site
        run: hugo --minify
        
      - name: Upload public folder recursively via SFTP
        env:
          SFTP_HOST: ftp.cluster130.hosting.ovh.net
          SFTP_USER: ${{ secrets.OVH_FTP_USER }}
          SFTP_PASS: ${{ secrets.OVH_FTP_PASSWORD }}
        run: |
          LOCAL_DIR=public
          REMOTE_DIR=/remote/path

          # Generate a list of folders to create on the remote
          find $LOCAL_DIR -type d | while read dir; do
            remote_path="$REMOTE_DIR/${dir#$LOCAL_DIR/}"
            echo "mkdir -p $remote_path"
          done > mkdirs.sftp

          # Generate a list of files to upload
          find $LOCAL_DIR -type f | while read file; do
            remote_path="$REMOTE_DIR/${file#$LOCAL_DIR/}"
            echo "put $file $remote_path"
          done >> mkdirs.sftp

          # Run sftp with batch file
          sftp -oBatchMode=no -b mkdirs.sftp $SFTP_USER@$SFTP_HOST
